---
title: objc750.1编译
comments: true
toc: true
copyright: true
declare: true
categories:
  - iOS
  - 源码编译
tags:
  - objc4
date: 2019-03-09 15:54:17
top:
---

　　本文内容：`macOS 10.14.1`下编译`objc4_750.1`源码。笔者不能保证在其他系统版本下编译成功，但是解决方法大同小异。
　　<!--more-->
### 编译环境
* macOS 10.14.1
* Xcode 10.1

### 准备工作
* [macOS 10.14.1 所有源码目录](https://opensource.apple.com/release/macos-10141.html)
* [objc4-750.1源码下载链接](https://opensource.apple.com/tarballs/objc4/objc4-750.1.tar.gz)

* 其他相关包下载链接。下载并解压到一个文件夹`tarballs`下，方便搜索。
    
    * [libplatform-177.200.16](https://opensource.apple.com/tarballs/libplatform/libplatform-177.200.16.tar.gz)
    * [xnu-4903.221.2](https://opensource.apple.com/tarballs/xnu/xnu-4903.221.2.tar.gz)
    * [libpthread-330.220.2](https://opensource.apple.com/tarballs/libpthread/libpthread-330.220.2.tar.gz)
    * [libmalloc-166.220.1](https://opensource.apple.com/tarballs/libmalloc/libmalloc-166.220.1.tar.gz)
    * [libdispatch-1008.220.2](https://opensource.apple.com/tarballs/libdispatch/libdispatch-1008.220.2.tar.gz)
    * [libclosure-73](https://opensource.apple.com/tarballs/libclosure/libclosure-73.tar.gz)
    * [Libc-1272.200.26](https://opensource.apple.com/tarballs/Libc/Libc-1272.200.26.tar.gz)
    * [libauto-187](https://opensource.apple.com/tarballs/libauto/libauto-187.tar.gz)
    * [dyld-635.2](https://opensource.apple.com/tarballs/dyld/dyld-635.2.tar.gz)
    * [pthread_machdep.h](https://opensource.apple.com/source/Libc/Libc-825.40.1/pthreads/pthread_machdep.h)
    * [CrashReporterClient.h](https://opensource.apple.com/source/Libc/Libc-997.90.3/include/CrashReporterClient.h)

* 在源码根目录中新建文件夹`include`, 用来存放需要补充的文件。然后打开项目，在`Building Settings - System Header Search Paths`中添加路径`$(SRCROOT)/include`

### 开始编译

* 编译，不出意外会出现错误`The i386 architecture is deprecated.···`

    ![objc7501_alter_target](https://i.loli.net/2019/03/03/5c7b88527c5c7.jpg)

* 先解决头文件缺失的错误，再处理其他的。
 
#### 报错一：头文件缺失
   
* 再编译，出现`'sys/reason.h' file not found`。在`tarballs`文件夹下搜索`reason.h`。
    ![search_head_file](https://i.loli.net/2019/03/03/5c7b8852590a8.jpg)

    由于前面有一个路径，需要在`include`下再新建一个文件夹`sys`，然后将`reason.h`复制到该文件夹下。
    ![head_file_path_example](https://i.loli.net/2019/03/03/5c7b88525679b.jpg)
    接下来就是一顿搜索加复制，如果提示缺失的头文件前有路径，需要自行创建；如果没有，那就直接放在`include`文件夹下。然后再次编译，处理新的错误直到成功。有区别的地方会做特殊说明。

* 使用相同操作的头文件还有
    * `mach-o/dyld_priv.h`
    * `os/lock_private.h`
    * `os/base_private.h`
    * `pthread/tsd_private.h`
    * `System/machine/cpu_capabilities.h`, 该文件会搜索到3个，使用上级文件夹为`machine`的那个。
    * `os/tsd.h`，使用上级文件夹为`os`那个。
    * `pthread/spinlock_private.h`

* 提示`System/pthread_machdep.h not found`, 
    * ~~下载[该头文件](https://opensource.apple.com/source/Libc/Libc-825.40.1/pthreads/pthread_machdep.h) 放到 `include/System`~~

    * 可以直接注释
    
* 提示`CrashReporterClient.h not found`, 
    * 下载[CrashReporterClient.h](https://opensource.apple.com/source/Libc/Libc-997.90.3/include/CrashReporterClient.h) 放到`include`下。

    * 编译仍会提示`not found`，在`Build Settings - Preprocessor Macros - Debug`中添加字段`LIBC_NO_LIBCRASHREPORTERCLIENT`

* `Block_private.h not found`, 搜索复制`BlocksRuntime`下的该文件到`include`。同样的还有
    * `objc-shared-cache.h`
    * `_simple.h`

* `'objc/objc-block-trampolines.h' file not found` 直接注释即可

#### 其他错误
* 在`dyld_priv.h`中报错`Expected ','`，这个问题有点无语，因为源文件中格式没有问题啊。笔者通过删除`bridgeos(3.0)`通过编译。希望有人能告知这是什么情况···

* `Typedef redefinition with different types ('int' vs 'volatile OSSpinLock' (aka 'volatile int'))`  重定义错误，说明其他地方也有相同的定义。把报错的那个注释即可

* `Static declaration of '_pthread_has_direct_tsd' follows non-static declaration` 一共有三个函数报错，全部注释即可。出现的原因是重定义。
    * `_pthread_has_direct_tsd`
    * `_pthread_getspecific_direct`
    * `_pthread_setspecific_direct`

* `isa.h file not found` 文件在项目根目录下的`runtime`文件夹下，只是没有引入。在`Building Settings - System Header Search Paths`中添加路径`$(SRCROOT)/runtime`

* `Use of undeclared identifier 'DYLD_MACOSX_VERSION_10_13'` 系统版本号的宏定义找不到，类似的还有`10.11，10.12，10.14`的。

    在`dyld_priv.h`头部添加以下宏
    
    ```
    #define DYLD_MACOSX_VERSION_10_11 0x000A0B00
    #define DYLD_MACOSX_VERSION_10_12 0x000A0C00
    #define DYLD_MACOSX_VERSION_10_13 0x000A0D00
    #define DYLD_MACOSX_VERSION_10_14 0x000A0E00
    ```
    按照上面这个节奏，如果有`macOS 10.15`, 那也许在对应的`objc4`源码中还要加上(16进制)
    
    ```
    #define DYLD_MACOSX_VERSION_10_15 0x000A0F00
    ```
    
* `linker command failed with exit code 1`

    * 在`Build Settings - Other Linker Flags - Debug和Release`中删除`-lCrashReporterClient`字段

    * 在`Build Settings - Order File`中路径改为`$(SRCROOT)/libobjc.order`

* `SDK "macosx.internal" cannot be located.`

    在`Build Phrases - Run Script`中删掉`.internal`
    
* `no such public header file: '/tmp/objc.dst/usr/include/objc/ObjectiveC.apinotes'` 

    * 删除 `Build Settings - Other Text-Based installAPI Flags` 下的所有值

    * 修改 `Text-Based InstallAPI Verification Mode` 为 `Errors Ony`

* 编译成功，可以开始调试 OC 底层源码了。

### 添加调试 Target
* 项目配的架构是 `x86_64`的，所以 Target 需要是 macOS 下的。都是同一个妈生的，macOS 下调试和 iOS 下调试都差不多的。

    ![new_target](https://i.loli.net/2019/03/03/5c7b8852542dd.jpg)
    
    推荐使用`command line tool`，体积小
	![objc_target_comandtool](https://i.loli.net/2019/03/03/5c7b885255cec.jpg)
    
    创建好后别忘了选择你新建的 scheme
    ![scheme_build](https://i.loli.net/2019/03/03/5c7b8852415da.jpg)
    
    > 如果添加 target 后，断点不能进入到源码中。Xcode 菜单 `Product - Scheme - Edit Scheme`, 在`Build`一栏下添加源码的 target。再运行，笔者这里就能进入源码了。
    > ![target_scheme](https://i.loli.net/2019/03/06/5c7ea0d32c269.jpg)

### 参考链接
* https://www.jianshu.com/p/9e0fc8295c4b

* https://www.imooc.com/article/268031?block_id=tuijian_wz